# Update jobs (README, etc.)

update:readme:
  extends:
    - .base_setup
  stage: update

  needs:
    - job: heartbeat:time/clock
      optional: true

  before_script:
    # if vscode complains: "yaml.customTags": ["!reference sequence"] in settings.json
    - !reference [.base_setup, before_script]
    # Install additional dependencies for README updates if needed
    # - apt update && apt install -y libfaketime
    - git config --global user.name "waldiez-bot"
    - git config --global user.email "bot@waldiez.io"

  script:
    - |
      # Update README
      bash scripts/agents/time/clock/update_readme.sh

      # Commit if changed
      if [[ -n "$(git status -s README.md)" ]]; then
        git add README.md
        git commit --no-verify -m "chore: Update README.md with current status"
        PORT=""
        if [[ "$CI_SERVER_PORT" != "80" && "$CI_SERVER_PORT" != "443" ]]; then
          PORT=":$CI_SERVER_PORT"
        fi
        git push ${CI_SERVER_PROTOCOL}://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}${PORT}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
      else
        echo "No changes to README.md"
      fi

  rules:
    # Run after heartbeat completes
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run on push to time/clock files
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - time/clock/.toc
        - time/clock/MANIFEST
